<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/f/funatsufumiya/20210810/20210810221217.jpg" alt="f:id:funatsufumiya:20210810221217j:plain" width="1125" height="705" loading="lazy" title="" class="hatena-fotolife" itemprop="image"></span></p>
<p>タイトルの通りなのだけど、今回は実際使っている動画を撮ってみた。自分のタイピングの拙さとかもそのまんま収録されてるけど、百聞は一見に如かずだと思う。</p>
<p><iframe width="420" height="315" src="https://www.youtube.com/embed/tulSwkCzn0E?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><cite class="hatena-citation"><a href="https://youtu.be/tulSwkCzn0E">youtu.be</a></cite></p>
<p>何をやったのかというと、<a href="https://funatsufumiya.hatenablog.com/entry/2021/07/27/232436">まず前回</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DD%A5%E1%A5%E9">ポメラ</a>ハックを開始して、とりあえず普通に使える<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> (<a class="keyword" href="http://d.hatena.ne.jp/keyword/Debian">Debian</a>) として使えるようにして満足した。ここまでは、ネット上の記事とかにいろいろ情報が書かれているので割愛。（<a href="https://qiita.com/alt-core/items/d62c6447c607fbf6e8bf">このQiita記事</a>とかはとても参考になった。）</p>
<p>自分が今回やったことは、自作のキー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%DF%A5%E5%A5%EC%A1%BC%A5%BF%A1%BC">エミュレーター</a>を<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> (<a class="keyword" href="http://d.hatena.ne.jp/keyword/Debian">Debian</a>)上で動かして、新下駄配列＋DvorakPが打てるようにした。</p>
<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Ffunatsufumiya%2Fshingeta-linux-ruby" title="GitHub - funatsufumiya/shingeta-linux-ruby" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://github.com/funatsufumiya/shingeta-linux-ruby">github.com</a></cite></p>
<p>やっていることは<a href="https://github.com/inwskatsube/oyainput">oyainput</a>や<a href="https://github.com/derui/okeyfum">okeyfum</a>と同じで、<code>/dev/input/event0</code> などのキー入力を読み取り、かつバイパス（grab）して、 <code>/dev/uinput</code> を使ってキーを変更。実際使うときはoyainput同様に、nohupなど別プロセスとして起動して使う。</p>
<p>自分の作った<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%DF%A5%E5%A5%EC%A1%BC%A5%BF%A1%BC">エミュレーター</a>で特筆すべき点は、</p>
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>で書かれている（コードは1ファイルのみ）</li>
<li>やまぶきR用のキー設定ファイルが、ある程度そのまま使える</li>
<li>Grabの定数をコード中で指定</li>
</ul>

<p>だと思う。上の２つは開発の簡単さと修正のしやすさのため。ただ、やまぶきRの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BF%C6%BB%D8%A5%B7%A5%D5%A5%C8">親指シフト</a>入力と挙動は違っていて、自分自身が<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BF%C6%BB%D8%A5%B7%A5%D5%A5%C8">親指シフト</a>系を使っていないのでシフトキーの挙動は現時点では適当。一方で、新下駄配列を快適に入力するために、文字キー同士の同時打鍵タイミングには凝った。まだ妙な挙動はあるものの、プロトタイプとしては満足。タイミングはソース中で指定できるけど、後々パラメータとして外部に出せたらと思ったりする。（やまぶきR用設定ファイルのパーサーも適当に取り急ぎ作ったものなので、後々ちゃんと書き直したい。書き直すときはそもそも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>じゃなくてRustとかにしたいけど、まずその前に日本語切り替えをMozc連動に改良したい。）</p>
<p>最後の一つ、Grabの定数指定については、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DD%A5%E1%A5%E9">ポメラ</a>DM200での使用に特化した内容。前述のoyainputは素直に動いたのにokeyfumが動かなかった点に事の発端がある。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DD%A5%E1%A5%E9">ポメラ</a>DM200は32ビットのARMマシンであるせいか、<a class="keyword" href="http://d.hatena.ne.jp/keyword/OCaml">OCaml</a>や<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>中のGrabの定数がint32の範囲を超えてエラーしてしまい正しく動かなかった。直接<a class="keyword" href="http://d.hatena.ne.jp/keyword/C%B8%C0%B8%EC">C言語</a>から呼ぶと全く問題ないので、イマイチ腑に落ちなかったものの、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>の場合は直接指定すると動いたので、そうした。</p>
<p>ちなみに、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Debian">Debian</a>は<a href="https://www.ekesete.net/log/?p=8940">人柱版 その2</a> を使ったのだけれど、作者の追記にあるように、今回のようなキー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%DF%A5%E5%A5%EC%A1%BC%A5%BF%A1%BC">エミュレーター</a>を使えるようにするためには、<code>/dev/uinput</code> を有効にする<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>更新をする必要がある点に注意。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>更新といってもとても簡単で、方法は前述のQiita記事中にある。</p>
<p>さらにDM200に限った注意としては、<code>/dev/input/event</code> にいくつか制約があるので、デ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>名の列挙など使えない機能がある点に注意。自分のキー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%DF%A5%E5%A5%EC%A1%BC%A5%BF">エミュレータ</a>で使っているrevdevライブラリでも、その理由で一箇所<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%E1%A5%F3%A5%C8%A5%A2%A5%A6%A5%C8">コメントアウト</a>しないと動かなかったので、DM200で使える版としてフォークしてある。（ <code>gem install revdev</code> の代わりにこのgitを使えばOK。あとでREADMEにも書こうかな。 ）</p>
<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Ffunatsufumiya%2Frevdev" title="GitHub - funatsufumiya/revdev: ruby binding to handling event devices (evdev)" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://github.com/funatsufumiya/revdev">github.com</a></cite></p>
<p>―― さて、今回は思いつき優先で、とりあえず勢いでキー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%DF%A5%E5%A5%EC%A1%BC%A5%BF">エミュレータ</a>まで書いてしまったのだけど、キー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%DF%A5%E5%A5%EC%A1%BC%A5%BF">エミュレータ</a>を作るのってとても楽しいなと実感した。今まで既存のキー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%DF%A5%E5%A5%EC%A1%BC%A5%BF">エミュレータ</a>を使っていて、微妙に痒いところに手が届かない感があったりしたけど、自分で作るとフルに自由にできて楽しい。特に<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>の場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>や<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>に比べてそんなに自作は難しくないし、今回のように<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>とかから気軽に呼べるライブラリが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>や<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>でもあると、もっと自由にキー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%DF%A5%E5%A5%EC%A1%BC%A5%BF">エミュレータ</a>とかキー割り当て変更が高度にできて楽しいだろうなと思った。</p>
<p>あと何より、DM200が素晴らしい。単純に<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>マシンとして見ても優秀だし、元のソフトやハード構成が素敵なので、シンプルに、書くことへの愛を感じる。ハックしなくても<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BF%C6%BB%D8%A5%B7%A5%D5%A5%C8">親指シフト</a>が使える<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EF%A1%BC%A5%D7%A5%ED">ワープロ</a>として貴重だし、ぜひ今後も販売し続けて欲しい。しいていえば、今回ハックした版にはMozc（<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AA%A1%BC%A5%D7%A5%F3%A5%BD%A1%BC%A5%B9">オープンソース</a>版<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google%C6%FC%CB%DC%B8%EC%C6%FE%CE%CF">Google日本語入力</a>）が入っているので推測変換が効くけど、元々の<a class="keyword" href="http://d.hatena.ne.jp/keyword/ATOK">ATOK</a>は推測変換が効かなくて辛いので、ぜひ次期版は推測変換できるようになったらいいなぁ。</p>
